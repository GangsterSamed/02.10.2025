# Сервис загрузки файлов

Простой HTTP-сервис для фоновой загрузки файлов по ссылкам.  
Пользователь отправляет список URL, а сервис скачивает файлы в фоне и сохраняет статус выполнения.

## Возможности

- **POST /tasks** — создать задачу на загрузку файлов
- **GET /tasks/{id}** — получить статус задачи
- Файлы скачиваются в папку `downloads/`
- Состояние задач сохраняется в `data/state.json`
- При перезапуске сервис восстанавливает незавершённые задачи
- Graceful shutdown: при остановке сервис сохраняет состояние

## Как работает

- В памяти хранится очередь задач
- Каждая задача состоит из набора файлов
- Для избежания конфликтов имён к файлам добавляется timestamp
- Состояние задач сохраняется в `data/state.json`
- При рестарте сервис восстанавливает задачи из `state.json` и продолжает загрузку

## Примеры использования

### Создать задачу
```bash
curl -X POST http://localhost:8080/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "urls": [
      "https://httpbin.org/json",
      "https://httpbin.org/image/png"
    ]
  }'
````

**Ответ:**

```json
{"id":"7ff..."}
```

### Проверить статус 

```bash
curl http://localhost:8080/tasks/7ff...
```

**Ответ:**

```json
{
  "id": "7ff...",
  "created_at": "2025-01-15T10:30:00Z",
  "status": "running",
  "files": [
    {
      "url": "https://httpbin.org/json",
      "status": "done",
      "path": "downloads/20260115-103000-json"
    },
    {
      "url": "https://httpbin.org/image/png", 
      "status": "downloading",
      "path": ""
    }
  ]
}
```

## Запуск

```bash
go run .
```

Сервис запустится на порту `8080`.

## Архитектурные решения и паттерны

* **Очередь задач** — для фонового выполнения загрузок.
* **Persisted state** — задачи сохраняются в `data/state.json`, чтобы пережить перезапуск.
* **Graceful shutdown** — при остановке сервис сохраняет все незавершённые задачи.
* **Atomic write** — загрузка файлов идёт во временный `.part`, затем `rename`.
* **Идемпотентность** — повторный запрос с теми же URL не создаёт дублей (опционально через Idempotency-Key).
* **Ретраи** — при сетевых ошибках файлы автоматически перекачиваются с задержкой (backoff).

## Тестовые сценарии

1. **Рестарт во время загрузки** — начать скачивание, перезапустить сервис. После старта файлы продолжают докачиваться.
2. **Несколько задач одновременно** — создать 2–3 задачи с разными URL и проверить, что они выполняются параллельно.
3. **Ошибочные URL** — добавить несуществующий адрес, убедиться, что статус файла = `failed`, а задача продолжает выполняться.
4. **Graceful shutdown** — отправить SIGINT (`Ctrl+C`), убедиться, что состояние сохранено и после перезапуска задачи возобновлены.

## Проверенные возможности

- ✅ Прием задач во время graceful shutdown
- ✅ Восстановление состояния после перезагрузки
- ✅ Параллельная обработка нескольких задач
- ✅ Детальный статус для каждого файла
- ✅ Обработка HTTP ошибок и сетевых сбоев